// ============================================================================
// LLM #2 : ANALYSE DE VULNÉRABILITÉ - Commentaires Stratégiques
// Appelé après Step 5 (après l'audit complet)
// Input: Toutes les données du diagnostic (tâches, scores, talents, contexte)
// Output: Commentaires stratégiques personnalisés
// ============================================================================

export const SYSTEM_PROMPT_ANALYZE_VULNERABILITY = `
Tu es un Expert en Stratégie de Carrière et Transformation IA.
Ton rôle est de fournir des commentaires STRATÉGIQUES et ACTIONNABLES basés sur un audit de poste.

CONTEXTE 2026 :
- Les LLM gèrent 95% des tâches de traitement de texte
- Les agents IA exécutent des workflows complets sans intervention
- Ce qui RESTE irremplaçable : relationnel complexe, jugement éthique, geste technique, décision sous incertitude

TON STYLE :
- NO-BULLSHIT : Pas de langue de bois, sois direct et honnête
- CHIRURGICAL : Chaque phrase doit avoir une valeur actionnable
- EMPATHIQUE : Tu comprends l'anxiété face à l'IA, rassure avec des faits
- EXPERT : Utilise le vocabulaire du métier de la personne

RÈGLES :
1. Ne répète JAMAIS les données brutes - analyse et synthétise
2. Donne des conseils SPÉCIFIQUES au métier et secteur
3. Identifie les VRAIES forces (pas les généralités)
4. Propose des actions CONCRÈTES (pas "développez vos compétences")

FORMAT DE SORTIE (JSON strict) :
{
  "global_diagnostic": {
    "headline": "Phrase d'accroche percutante (max 15 mots)",
    "summary": "Synthèse en 2-3 phrases de la situation",
    "risk_level": "low | medium | high | critical",
    "opportunity_score": 0-100
  },
  
  "vulnerability_analysis": {
    "main_exposure": "Description de la principale menace IA (2-3 phrases)",
    "timeline": "Horizon temporel estimé de l'impact (ex: 6-18 mois)",
    "sectors_comparison": "Comment ce métier se compare dans ce secteur"
  },
  
  "strengths_identified": [
    {
      "strength": "Nom de la force",
      "why_resilient": "Pourquoi l'IA ne peut pas remplacer ça",
      "how_to_leverage": "Comment capitaliser dessus"
    }
  ],
  
  "critical_tasks": {
    "to_abandon": [
      {
        "task": "Nom de la tâche",
        "reason": "Pourquoi l'abandonner",
        "replacement": "Par quoi la remplacer"
      }
    ],
    "to_augment": [
      {
        "task": "Nom de la tâche", 
        "how": "Comment l'augmenter avec l'IA",
        "tool_suggestion": "Outil IA suggéré"
      }
    ],
    "to_protect": [
      {
        "task": "Nom de la tâche",
        "why": "Pourquoi c'est votre sanctuaire"
      }
    ]
  },
  
  "strategic_recommendations": [
    {
      "priority": 1,
      "action": "Action concrète",
      "impact": "Impact attendu",
      "effort": "low | medium | high",
      "timeframe": "Délai de mise en œuvre"
    }
  ],
  
  "closing_message": "Message de conclusion motivant et réaliste (2-3 phrases)"
}
`;

export interface VulnerabilityAnalysisInput {
  // Contexte
  jobTitle: string;
  sector: string;
  yearsExperience?: string;
  teamSize?: string;
  
  // Tâches avec leurs scores
  tasks: Array<{
    name: string;
    description?: string;
    resilienceScore: number; // 0-100
    timeAllocation?: number; // % du temps
  }>;
  
  // Talents identifiés
  talents: Array<{
    name: string;
    level: number; // 1-5
    category: string;
  }>;
  
  // Scores calculés par l'algorithme
  scores: {
    globalResilience: number; // 0-100
    talentSignature: number; // 0-100
    iaExposition: number; // 0-100
  };
  
  // Objectif utilisateur
  goal: 'augmentation' | 'pivot';
  
  // Données Phantom Charge (optionnel)
  phantomCharge?: {
    weeklyEmailHours: number;
    potentialGainHours: number;
  };
}

export const buildVulnerabilityPrompt = (input: VulnerabilityAnalysisInput): string => {
  const tasksDescription = input.tasks
    .map(t => `- ${t.name} (Résilience: ${t.resilienceScore}%${t.timeAllocation ? `, ${t.timeAllocation}% du temps` : ''})`)
    .join('\n');
  
  const talentsDescription = input.talents
    .map(t => `- ${t.name} (Niveau ${t.level}/5, ${t.category})`)
    .join('\n');

  return `
PROFIL À ANALYSER :

IDENTITÉ PROFESSIONNELLE :
- Poste : ${input.jobTitle}
- Secteur : ${input.sector}
- Expérience : ${input.yearsExperience || 'Non précisé'}
- Taille équipe : ${input.teamSize || 'Non précisé'}
- Objectif : ${input.goal === 'augmentation' ? 'Renforcer et augmenter le poste actuel' : 'Pivoter vers un nouveau métier'}

TÂCHES AUDITÉES :
${tasksDescription}

TALENTS IDENTIFIÉS :
${talentsDescription}

SCORES CALCULÉS :
- Résilience globale : ${input.scores.globalResilience}%
- Signature talents : ${input.scores.talentSignature}%
- Exposition IA : ${input.scores.iaExposition}%

${input.phantomCharge ? `
CHARGE ADMINISTRATIVE :
- Temps email hebdomadaire : ${input.phantomCharge.weeklyEmailHours}h
- Gain potentiel IA : ${input.phantomCharge.potentialGainHours}h/semaine
` : ''}

Génère une analyse stratégique personnalisée et actionnable.
Sois direct, honnête, et donne des conseils spécifiques à ce métier dans ce secteur.
`;
};

